worker_processes auto;

events { worker_connections 1024; }

http {
    # Trust ALB
    real_ip_header X-Forwarded-For;
    set_real_ip_from 0.0.0.0/0;

    # Rate limit per client IP
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    upstream php {
        server 127.0.0.1:9000;
    }

    server {
        listen 80;

        root /var/www/public;
        index index.php;

        location /health {
            include fastcgi_params;
            fastcgi_pass php;
            fastcgi_param SCRIPT_FILENAME /var/www/public/index.php;
        }

        location /api {
            limit_req zone=api_limit burst=5 nodelay;
            limit_req_status 429;

            error_page 429 = @rate_limited;

            include fastcgi_params;
            fastcgi_pass php;
            fastcgi_param SCRIPT_FILENAME /var/www/public/index.php;
        }

        location @rate_limited {
            default_type application/json;
            return 429 '{"error":"Too Many Requests"}';
        }

        location / {
            return 404;
        }
    }
}
